# Fastlink WSC******************## About WSC**********************## Fastlink WSC Dev server setupThis  Back-end web application provides a REST APIs built with (Laravel Framework). To set up this web application ona hosting server follow these points:------------------## **Requirements**All these services should be installed.#### 1- PHP version 8.2 with default extensions and plus the followings:    - zip     - libpq-dev    - libcurl4-gnutls-dev "yum install libcurl-devel"    - pdo    - libxml2-dev "yum install libxml2-devel"    - Mbstring    - php8.2-bcmath     - **** oci8 *****    - JSON    - Ctype    - OpenSSL    - Tokenizer------------------#### 2- Composer.```shell    composer install --no-progress --no-interaction```------------------#### 3- PostgreSQL 15.* Create the `Main Database` and add the related credential to the `Laravel` project `.env` file.    ```dotenv        DB_HOST=database # hostname        DB_PORT=5432   # port        DB_DATABASE=wsc_fastlink_db  # DB name        DB_USERNAME=wsc_fastlink_user # DB username        DB_PASSWORD=*********  # DB password    ```* Create `Usage Database` and add the related credential to the `Laravel` project `.env` file.   ```dotenv    USAGE_DB_HOST=usage_database # hostname    USAGE_DB_PORT=5432 # port    USAGE_DB_DATABASE=usage_fastlink_db  # DB name    USAGE_DB_USERNAME=usage_fastlink_user # DB username    USAGE_DB_PASSWORD=*********  # DB password    ```------------------#### 4- SupervisorSupervisor a client/server system that allows its users to monitor and control a number of processes on UNIX-likeoperating systems. It will automatically restart the processes if they fail.- Create a Configuration file    ```shell    echo_supervisord_conf > /etc/supervisord.conf    ```- use text editor nano /etc/supervisord.conf and add the following    ```dotenv    [include]    files = /etc/supervisord.d/*.ini    ```- Create the Laravel Queue Worker Supervisor Setup in path `/etc/supervisord.d/` with name `larave_worker_fastlink_api.ini`:    ```dotenv    [program:laravel-worker]      command=php /var/www/wsc-admin-api/artisan queue:work    process_name=%(program_name)s_%(process_num)03d    numprocs=2    priority=999    autostart=true    autorestart=true      startsecs=1    startretries=3    user=root    redirect_stderr=true    stdout_logfile=/var/www/wsc-admin-api/worker.log    ```- Create the Minio S3 Worker Supervisor Setup in path `/etc/supervisord.d/` with name `minio_fastlink.ini`:    ```dotenv    [program:minio-serve]    command=minio server --address :9005 /path/to/minio --console-address :9088    process_name=%(program_name)s_%(process_num)03d    numprocs=2    priority=999    autostart=true    autorestart=true    startsecs=1    startretries=3    user=root    redirect_stderr=true    stdout_logfile=/var/www/wsc-admin-api/minio.log    ```------------------#### 5- Minio  MinIO is a high performance object storage solution that provides an Amazon Web Services S3-compatible API andsupports all core S3 features.- Create a new Bucket.- Create Access Keys.- Add the related credential to the `Laravel` project `.env` file.    ```dotenv    FILESYSTEM_CLOUD=minio    MINIO_ENDPOINT="http://127.0.0.1:9005" your IP and Port    AWS_KEY=*********** your key    AWS_SECRET=************************ your secret    AWS_REGION="me-central-1"    AWS_BUCKET=bucket_name    ```------------------### 6- RedisRedis is an open source (BSD licensed), in-memory data structure store used as a database, cache,message broker, and streaming engine. you have to add the Redis connection params to the `Laravel` project `.env` file.```dotenvREDIS_HOST=hostname # your hostREDIS_PASSWORD=****** #your-passwordREDIS_PORT=6379 #  portREDIS_CLIENT=predis```------------------### 7- Crontab :The cron daemon is a long-running process that executes commands at specific dates and times. You can use thisto schedule activities, either as one-time events or as recurring tasks.```shell* * * * * cd /var/www/wsc-admin-api && php artisan schedule:run >> /dev/null 2>&1```------------------------###  **Env Variables**The following variables should be synced and added to the`.env`according to the deployment environment:* Main and UsageDB connection as mentioned in  [PostgreSQL Section]().* Redis Connection as mentioned in  [Redis Section]().* DWH Connection  ```dotenv    DWH_DB_CONNECTION=development_dwh    DWH_TABLE=wsc_usage_dtl    DWH_DB_HOST=127.0.0.1    DWH_DB_PORT=3306    DWH_DB_DATABASE=portal    DWH_DB_USERNAME=portal_user # username    DWH_DB_PASSWORD=*********** # password    DWH_DB_SERVICE_NAME=dbm    ```* Firebase Connection.    ```dotenv    FIREBASE_CREDENTIALS=fcm/firebase_service_account.json # path to the FCM credencial file    ```* Minio Connection as mentioned in  [Minio Section]().* OCS Connection.    ```dotenv    OCS_ENCRYPTION_KEY="BMEIMPL@YYYYMMDD"    OCS_LIVE_BASE_URL="http://172.20.18.51:8580/services/"  # Live URL    OCS_BASE_URL="http://172.20.18.57:8580/services/" # Dev URL    OCS_USERNAME="WSC2"    OCS_PASSWORD=*********************    SOAP_VERSION=1.0    ```* HSS Connection.    ```dotenv    HSS_BASE_URL=http://172.20.13.138:9000 # HSS URL and Port    CNTXID=3 # env param    APNTPLID=8 # env param    ```* Subscriber Portal Domain    ```dotenv    SUBSCRIBER_PORTAL_DOMAIN=https://new-my-fastlink.newroz4g.com    ```* Admin Portal (Remix Server) IP    ```dotenv    FRONTEND_SERVER_IP=172.20.21.116    ```* Passport Personal Access ID and Secret key.    ```dotenv    PASSPORT_PERSONAL_ACCESS_CLIENT_ID=***************    PASSPORT_PERSONAL_ACCESS_CLIENT_SECRET=*******************************    ```* Passport Public and Private keys.    ```dotenv    PASSPORT_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----    <private key here>    -----END RSA PRIVATE KEY-----"    PASSPORT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----    <public key here>    -----END PUBLIC KEY-----"    ```###  Deployment:Within the deployment process go to the root of the project `/var/www/wsc-admin-api` and run the followings:1 - **_Composer_** : Run Composer install to include the new added packages.```shellcomposer install && composer dump-autoload --optimize```2- _**Migrations**_ : Run the none applied migrations.# migrate schemas etc, ```shell  php artisan migrate --database=pgsql --path="database/migrations/admin";  php artisan migrate --path="database/migrations/usage"```3- _**Seeder**_ : Run the seeder class to seed the initial data (_**Just for first deployment after the server installation**_)```shell    php artisan db:seed --class=InitialDataSeeder```4- **_Passport_** :When deploying Passport to your application's server for the first time, you will likely need to run the`passport:keys` command. This command generates the encryption keys Passport needs in order to generateaccess tokens. The generated keys are not typically kept in source control:```shell    php artisan passport:keys```* The default location where the `Public` and `Private` keys is in the `./storage` path.If necessary, you may define the path where Passport's keys should be loaded from. You may use the`Passport::loadKeysFrom` method to accomplish this. Typically, this method should be called from the bootmethod of your application's `App\Providers\AuthServiceProvider`.    ```php    public function boot()    {        $this->registerPolicies();        Passport::loadKeysFrom(__DIR__.'/../path/to/secrets');    }    ```* _**Loading Keys From The Environment**_: you may load your application's encryption keys by defining them as environment variables:    ```dotenv    PASSPORT_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----    <private key here>    -----END RSA PRIVATE KEY-----"    PASSPORT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----    <public key here>    -----END PUBLIC KEY-----"    ```------------------### PassportPassport provides a full OAuth2 server implementation for your Laravel application.* Create Encryption Key: ```shell    php artisan passport:install```This command will create the following encryption keys:* _**Personal Access Client**_: This key should be added to the **_Laravel_** `.env` file.    ```dotenv    PASSPORT_PERSONAL_ACCESS_CLIENT_ID=***************    PASSPORT_PERSONAL_ACCESS_CLIENT_SECRET=*******************************    ```* **_Password Grant client_**: This key should be added to the **_admin portal Remix Server_** `.env` file.    ```dotenv    PASSPORT_GRANT_CLIENT_ID=***************    PASSPORT_GRANT_CLIENT_SECRET=*******************************    ``````shell    php artisan passport:client --password```This command will create the following encryption keys:* **_Password Grant client_**: This key should be added to the **customer care Remix Server_** `.env` file.    ```dotenv    PASSPORT_GRANT_CLIENT_ID=***************    PASSPORT_GRANT_CLIENT_SECRET=*******************************    ```[root@be-09-prod wsc-admin-api]# php artisan passport:client --passwordWhat should we name the password grant client? [Laravel Password Grant Client]:> customer_careWhich user provider should this client use to retrieve users? [users]:  [0] users  [1] subscribers> 0Password grant client created successfully.Here is your new client secret. This is the only time it will be shown so don't lose it!Client ID: 98af8c7c-f3e1-46d8-9fc9-0814e60f54ddClient secret: uBvb622Cl6vBtQHoXj5oHINLcvEEt3us0O486cur[root@be-09-prod wsc-admin-api]# ```mermaidflowchart TBRelease-->Migration(Backward compitable migration)-->|9 backends|haproxy-->|first backend|backend-->|dont forward request|drain-->|out of service|maintaince(maintaince mode)-->8(at this point you 8 backends)-->deployin(deploying new backend)-->removem(remove maintaince)-->back(back to service)-->you(you have 9 backends 1 new and 8 old)```# ALL DB changes should be backward compitable# health check# Run migration once before drain, after the release3 & 4 init deploy4 should be same on all bespassport, run it once, then store it in github secrets, should be 4 values, 2 in backend, 2 in forntend adming portal and customer care.Encryption keys already exist. Use the --force option to overwrite them.Personal access client created successfully.Here is your new client secret. This is the only time it will be shown so don't lose it!Client ID: 98af89b3-dec3-49ba-bc9e-384c3ff5077dClient secret: Az5TZtp6cfKvfswydD1aPqKgXzyUh6XCFtrYNhEmPassword grant client created successfully.Here is your new client secret. This is the only time it will be shown so don't lose it!Client ID: 98af89b3-fbe6-4961-8977-cbb4527fb601Client secret: UtDiAjXSsBBH7sB2B5BxtuXFa5kdZoEazXpQKNzA```mermaidflowchart LRdevelopment-->stage-->|business|productiondevelopment------->here```
